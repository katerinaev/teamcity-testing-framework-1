name: Run tests

on:
  workflow_call:
    inputs:
      package:
        description: api | ui
        required: true
        type: string

jobs:
  validate-checkstyle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: Give execute permission for mvnw
        run: chmod +x ./mvnw

      - name: Validate Checkstyle
        run: ./mvnw validate

  run-tests:
    needs: validate-checkstyle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Teamcity Setup
        uses: ./.github/actions/teamcity-setup

      - name: Run tests
        continue-on-error: true
        # –£–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–µ—Ç–∞–ø–æ–º Teamcity
        run: ./mvnw test -Dtest='com.example.teamcity.${{ inputs.package }}.**' -Dgroups=Regression

      # üïì –î–æ–±–∞–≤–ª—è–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ TeamCity –ø–µ—Ä–µ–¥ Swagger Coverage
      - name: Wait for TeamCity to start
        if: ${{ inputs.package == 'api' }}
        shell: bash
        run: |
          echo "‚è≥ Waiting for TeamCity to become available..."
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$HOST:8111/app/rest/swagger.json || true)
             if [ "$STATUS" == "200" ]; then
               echo "‚úÖ TeamCity Swagger API is ready!"
               break
             fi
             echo "Still waiting... ($i/30) HTTP $STATUS"
             sleep 10
          done

      # –°–æ–∑–¥–∞–µ–º —Ä–µ–ø–æ—Ä—Ç —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º API —Ç–µ—Å—Ç–æ–≤, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–º –Ω–∞ Swagger
      # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://github.com/viclovsky/swagger-coverage
      # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä SwaggerCoverageRestAssured –≤ RestAssured# –°–æ—Ö—Ä–∞–Ω—è–µ–º Swagger Report –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã GitHub Actions
      - name: Run Swagger Coverage
        continue-on-error: true
        if: ${{ inputs.package == 'api' }}
        run: |
          chmod +x .swagger-coverage-commandline/bin/swagger-coverage-commandline
                    .swagger-coverage-commandline/bin/swagger-coverage-commandline \
                      -s http://$HOST:8111/app/rest/swagger.json \
                      -i target/swagger-coverage-output
      # –°–æ—Ö—Ä–∞–Ω—è–µ–º Swagger Report –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã GitHub Actions
      - name: Save Swagger Coverage
        uses: actions/upload-artifact@v4
        if: ${{ inputs.package == 'api' }}
        with:
          name: swagger-coverage
          path: |
            swagger-coverage-report.html
            swagger-coverage-results.json

      # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é Allure Report —Å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –≤–µ—Ç–∫–∏ gh-pages (https://allurereport.org/docs/integrations-github/)
      - name: Load test report history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build test report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: target/allure-results
          subfolder: ${{ inputs.package }}

      # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –≤–µ—Ç–∫—É gh-pages –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ https://gist.github.com/ramnathv/2227408
      - name: Publish test report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history